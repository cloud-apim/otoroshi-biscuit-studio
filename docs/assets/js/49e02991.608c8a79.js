"use strict";(self.webpackChunkotoroshi_biscuit_studio_documentation=self.webpackChunkotoroshi_biscuit_studio_documentation||[]).push([[524],{62107:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"plugins/remotetokenfetcher","title":"Remote token fetcher","description":"Similar to the \\"Biscuit to user\\" and \\"apikey bridge\\" plugins, this plugin retrieves a Biscuit token based on the","source":"@site/docs/plugins/remotetokenfetcher.mdx","sourceDirName":"plugins","slug":"/plugins/remotetokenfetcher","permalink":"/otoroshi-biscuit-studio/docs/plugins/remotetokenfetcher","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"Biscuit to ApiKey Bridge Plugin","permalink":"/otoroshi-biscuit-studio/docs/plugins/apikeybridge"},"next":{"title":"API Documentation","permalink":"/otoroshi-biscuit-studio/docs/api"}}');var i=t(74848),s=t(28453);t(16438);const r={sidebar_position:8},a="Remote token fetcher",l={},c=[{value:"Configuration",id:"configuration",level:2},{value:"Demo",id:"demo",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"remote-token-fetcher",children:"Remote token fetcher"})}),"\n",(0,i.jsx)(n.p,{children:'Similar to the "Biscuit to user" and "apikey bridge" plugins, this plugin retrieves a Biscuit token based on the\nrequest context (HTTP resource, connected user, used API key, etc.). The token is retrieved via an HTTP call,\nand the remote server is responsible for generating the token. This token is then re-injected into the current\nHTTP request or made available in Otoroshi\'s expression language for a future step in Otoroshi\'s plugin pipeline.'}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The plugin requires a minimal configuration to function properly. Below is a sample configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'{\n  "api_url": "http://foo.bar",\n  "api_method": "POST",\n  "api_headers": {\n  "Content-Type": "application/json",\n    "Authorization": "Bearer ${user.tokens.access_token}"\n  },\n  "api_timeout": 10000,\n  "api_tls_config": { // mTLS config\n    "certs": [],\n    "trusted_certs": [],\n    "enabled": false,\n    "loose": false,\n    "trust_all": false\n  },\n  "token_replace_loc": "header",\n  "token_replace_name": "Authorization",\n  "token_resp_loc": "token",\n  "otoroshi_ctx": false // inject otoroshi context in the http body\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"demo",children:"Demo"}),"\n",(0,i.jsx)(n.p,{children:"the code for the server that return a biscuit can be the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const http = require('http');\n\nconst PORT = 3214;\n\nconst server = http.createServer((req, res) => {\n  if (req.method !== 'POST' || req.url !== '/biscuit') {\n    res.writeHead(404, { 'Content-Type': 'application/json' });\n    return res.end(JSON.stringify({ error: 'Not found' }));\n  }\n\n  let body = '';\n  req.on('data', chunk => { body += chunk; });\n  req.on('end', () => {\n    // R\xe9ponse JSON\n    const payload = { biscuit: 'EpIBCigKB21hdGhpZXUKBG5hbWUYAyIJCgcIDhIDGIAIIgoKCAiBCBIDGIAIEiQIABIgCV15zxTAdpClBP3QLjdUEmrrXFsdEWq2-_wHWzfXMSUaQLLIaxZgEPQVD1q3H75dkalbp7bgZHLiDAPRMQwkIZ0J0cCf4oJJEEvg4u72EYveuvPvS6FCQ5osP_yRB72VeQIiIgoguLVPQPF0tnYnrJt6VAM3dzi7cyUJdnw3tnaenDRLSDs=' };\n    const json = JSON.stringify(payload);\n\n    res.writeHead(200, {\n      'Content-Type': 'application/json',\n      'Content-Length': Buffer.byteLength(json)\n    });\n    res.end(json);\n  });\n});\n\nserver.listen(PORT, () => {\n  console.log(`Server listening on http://localhost:${PORT}`);\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"now create a route in otoroshi with the following configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/proxy.otoroshi.io/v1/routes" \\\n  -d \'\n{\n  "_loc": {\n    "tenant": "default",\n    "teams": [\n      "default"\n    ]\n  },\n  "id": "route_a2d39581b-ce95-4920-b397-54ee07870949",\n  "name": "test biscuit plugins",\n  "description": "A new route",\n  "tags": [],\n  "metadata": {\n    "created_at": "2025-09-24T09:53:31.665+02:00"\n  },\n  "enabled": true,\n  "debug_flow": false,\n  "export_reporting": false,\n  "capture": false,\n  "groups": [\n    "default"\n  ],\n  "bound_listeners": [],\n  "frontend": {\n    "domains": [\n      "remotebiscuit.oto.tools"\n    ],\n    "strip_path": true,\n    "exact": false,\n    "headers": {},\n    "cookies": {},\n    "query": {},\n    "methods": []\n  },\n  "backend": {\n    "targets": [\n      {\n        "id": "target_1",\n        "hostname": "request.otoroshi.io",\n        "port": 443,\n        "tls": true,\n        "weight": 1,\n        "backup": false,\n        "predicate": {\n          "type": "AlwaysMatch"\n        },\n        "protocol": "HTTP/1.1",\n        "ip_address": null,\n        "tls_config": {\n          "certs": [],\n          "trusted_certs": [],\n          "enabled": false,\n          "loose": false,\n          "trust_all": false\n        }\n      }\n    ],\n    "root": "/",\n    "rewrite": false,\n    "load_balancing": {\n      "type": "RoundRobin"\n    },\n    "client": {\n      "retries": 1,\n      "max_errors": 20,\n      "retry_initial_delay": 50,\n      "backoff_factor": 2,\n      "call_timeout": 30000,\n      "call_and_stream_timeout": 120000,\n      "connection_timeout": 10000,\n      "idle_timeout": 60000,\n      "global_timeout": 30000,\n      "sample_interval": 2000,\n      "proxy": {},\n      "custom_timeouts": [],\n      "cache_connection_settings": {\n        "enabled": false,\n        "queue_size": 2048\n      }\n    },\n    "health_check": {\n      "enabled": false,\n      "url": "",\n      "timeout": 5000,\n      "healthyStatuses": [],\n      "unhealthyStatuses": [],\n      "blockOnRed": false\n    }\n  },\n  "backend_ref": null,\n  "plugins": [\n    {\n      "enabled": true,\n      "debug": false,\n      "plugin": "cp:otoroshi.next.plugins.OverrideHost",\n      "include": [],\n      "exclude": [],\n      "config": {},\n      "bound_listeners": [],\n      "nodeId": "cp:otoroshi.next.plugins.OverrideHost",\n      "plugin_index": {\n        "transform_request": 0\n      }\n    },\n    {\n      "plugin_index": {\n        "transform_request": 1\n      },\n      "nodeId": "cp:otoroshi_plugins.com.cloud.apim.otoroshi.extensions.biscuit.plugins.BiscuitRemoteTokenFetcherPlugin-0",\n      "plugin": "cp:otoroshi_plugins.com.cloud.apim.otoroshi.extensions.biscuit.plugins.BiscuitRemoteTokenFetcherPlugin",\n      "enabled": true,\n      "debug": false,\n      "include": [],\n      "exclude": [],\n      "bound_listeners": [],\n      "config": {\n        "api_url": "http://localhost:3214/biscuit",\n        "api_method": "POST",\n        "api_headers": {\n          "Content-Type": "application/json",\n          "Authorization": "Bearer ${user.tokens.access_token}"\n        },\n        "api_timeout": 10000,\n        "api_tls_config": {\n          "certs": [],\n          "trusted_certs": [],\n          "enabled": false,\n          "loose": false,\n          "trust_all": false\n        },\n        "token_replace_loc": "header",\n        "token_replace_name": "Authorization",\n        "token_resp_loc": "biscuit",\n        "otoroshi_ctx": true\n      }\n    },\n    {\n      "plugin_index": {\n        "transform_request": 2\n      },\n      "nodeId": "cp:otoroshi.next.plugins.AdditionalHeadersIn-0",\n      "plugin": "cp:otoroshi.next.plugins.AdditionalHeadersIn",\n      "enabled": true,\n      "debug": false,\n      "include": [],\n      "exclude": [],\n      "bound_listeners": [],\n      "config": {\n        "headers": {\n          "User-Biscuit": "${ctx.remote_fetched_biscuit}"\n        }\n      }\n    },\n    {\n      "plugin_index": {\n        "validate_access": 0\n      },\n      "nodeId": "cp:otoroshi.next.plugins.AuthModule-0",\n      "plugin": "cp:otoroshi.next.plugins.AuthModule",\n      "enabled": true,\n      "debug": false,\n      "include": [],\n      "exclude": [],\n      "bound_listeners": [],\n      "config": {\n        "pass_with_apikey": false,\n        "auth_module": null,\n        "module": "auth_mod_dev_1351bf36-ce8e-49f2-80a3-f82ea01b9468"\n      }\n    }\n  ],\n  "kind": "proxy.otoroshi.io/Route"\n}\'\n'})}),"\n",(0,i.jsxs)(n.p,{children:["and then test it in your browser by going to ",(0,i.jsx)(n.code,{children:"http://remotebiscuit.oto.tools:8080"})," et the result should look like:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "method": "GET",\n  "path": "/",\n  "headers": {\n    "host": "request.otoroshi.io",\n    "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",\n    "referer": "http://privateapps.oto.tools:8080/",\n    "connection": "keep-alive",\n    "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",\n    "user-biscuit": "EpIBCigKB21hdGhpZXUKBG5hbWUYAyIJCgcIDhIDGIAIIgoKCAiBCBIDGIAIEiQIABIgCV15zxTAdpClBP3QLjdUEmrrXFsdEWq2-_wHWzfXMSUaQLLIaxZgEPQVD1q3H75dkalbp7bgZHLiDAPRMQwkIZ0J0cCf4oJJEEvg4u72EYveuvPvS6FCQ5osP_yRB72VeQIiIgoguLVPQPF0tnYnrJt6VAM3dzi7cyUJdnw3tnaenDRLSDs=",\n    "authorization": "EpIBCigKB21hdGhpZXUKBG5hbWUYAyIJCgcIDhIDGIAIIgoKCAiBCBIDGIAIEiQIABIgCV15zxTAdpClBP3QLjdUEmrrXFsdEWq2-_wHWzfXMSUaQLLIaxZgEPQVD1q3H75dkalbp7bgZHLiDAPRMQwkIZ0J0cCf4oJJEEvg4u72EYveuvPvS6FCQ5osP_yRB72VeQIiIgoguLVPQPF0tnYnrJt6VAM3dzi7cyUJdnw3tnaenDRLSDs=",\n    "cache-control": "max-age=0",\n    "accept-language": "fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7,ca;q=0.6,la;q=0.5",\n    "upgrade-insecure-requests": "1",\n    "accept-encoding": "gzip, deflate",\n    "x-forwarded-for": "45.80.20.1",\n    "forwarded": "proto=https;for=45.80.20.1:52657;by=91.208.207.218",\n    "x-forwarded-port": "443",\n    "x-forwarded-proto": "https",\n    "sozu-id": "01K5XFSSE18QGYMZ6NAKG4F4BQ"\n  },\n  "cookies": {},\n  "body": null\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},16438:(e,n,t)=>{t(96540),t(74848)},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(96540);const i={},s=o.createContext(i);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);