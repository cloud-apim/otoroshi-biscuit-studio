"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[618],{29953:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"plugins/clientcredentials","title":"Client Credentials plugin","description":"this plugin can be used implement the OAuth2 clientcredentials flow with the accesstoken being a biscuit.","source":"@site/docs/plugins/clientcredentials.mdx","sourceDirName":"plugins","slug":"/plugins/clientcredentials","permalink":"/otoroshi-biscuit-studio/docs/plugins/clientcredentials","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Attenuator plugin","permalink":"/otoroshi-biscuit-studio/docs/plugins/attenuators"},"next":{"title":"API Documentation","permalink":"/otoroshi-biscuit-studio/docs/api"}}');var s=t(74848),o=t(28453);t(89229);const a={sidebar_position:3},r="Client Credentials plugin",l={},c=[{value:"Demo",id:"demo",level:2},{value:"Setup the <code>client_credentials</code> plugin",id:"setup-the-client_credentials-plugin",level:3},{value:"Setup API route",id:"setup-api-route",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"client-credentials-plugin",children:"Client Credentials plugin"})}),"\n",(0,s.jsxs)(n.p,{children:["this plugin can be used implement the OAuth2 ",(0,s.jsx)(n.code,{children:"client_credentials"})," flow with the ",(0,s.jsx)(n.code,{children:"access_token"})," being a biscuit.\nthis plugin is of kind ",(0,s.jsx)(n.code,{children:"Backend"}),". It expects a ",(0,s.jsx)(n.code,{children:"POST"})," with a typical OAuth2 ",(0,s.jsx)(n.code,{children:"client_credentials"})," flow payload."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'{\n  "grant_type": "client_credentials",\n  "client_id": "apikey_client_id",\n  "client_secret": "apikey_client_secret",\n  "bearer_kind": "biscuit",\n  "aud": "https://api.foo.bar" // optional\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"demo",children:"Demo"}),"\n",(0,s.jsxs)(n.p,{children:["let's try to implement a route protected by a biscuit tokens verifier where the token is issued by the ",(0,s.jsx)(n.code,{children:"client_credentials"})," plugin"]}),"\n",(0,s.jsxs)(n.h3,{id:"setup-the-client_credentials-plugin",children:["Setup the ",(0,s.jsx)(n.code,{children:"client_credentials"})," plugin"]}),"\n",(0,s.jsx)(n.p,{children:"first let's create an apikey"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/apim.otoroshi.io/v1/apikeys" \\\n  -d \'{\n  "_loc" : {\n    "tenant" : "default",\n    "teams" : [ "default" ]\n  },\n  "clientId" : "N5COev7kEpPBrbVg",\n  "clientSecret" : "iDba0Ahz2AMYU7Ao",\n  "clientName" : "test",\n  "description" : "",\n  "authorizedGroup" : null,\n  "authorizedEntities" : [ "route_bfda6474-0f81-4880-966e-8dae5c2683de", "route_4874704c-56a2-4460-9a21-ff8055a19c75" ],\n  "authorizations" : [ {\n    "kind" : "route",\n    "id" : "bfda6474-0f81-4880-966e-8dae5c2683de"\n  }, {\n    "kind" : "route",\n    "id" : "4874704c-56a2-4460-9a21-ff8055a19c75"\n  } ],\n  "enabled" : true,\n  "readOnly" : false,\n  "allowClientIdOnly" : false,\n  "throttlingQuota" : 10000000,\n  "dailyQuota" : 10000000,\n  "monthlyQuota" : 10000000,\n  "constrainedServicesOnly" : false,\n  "restrictions" : {\n    "enabled" : false,\n    "allowLast" : true,\n    "allowed" : [ ],\n    "forbidden" : [ ],\n    "notFound" : [ ]\n  },\n  "rotation" : {\n    "enabled" : false,\n    "rotationEvery" : 744,\n    "gracePeriod" : 168,\n    "nextSecret" : null\n  },\n  "validUntil" : null,\n  "tags" : [ ],\n  "metadata" : { }\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"then let's create a keypair"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/biscuit.extensions.cloud-apim.com/v1/biscuit-keypairs" \\\n  -d \'{\n  "id" : "biscuit-keypair_dev_d25612c6-b4d0-43ed-a711-16b6c09a5155",\n  "name" : "New Biscuit Key Pair",\n  "description" : "New biscuit KeyPair",\n  "metadata" : { },\n  "pubKey" : "771F9E7FE62784502FE34CE862220586D3DB637D6A5ABAD254F7330369D3B357",\n  "privKey" : "4379BE5B9AFA1A84F59D2417C20020EF1E47E0805945535B45616209D8867E50",\n  "tags" : [ ]\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"then let's create a forge"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/biscuit.extensions.cloud-apim.com/v1/biscuit-forges" \\\n  -d \'{\n  "id" : "biscuit-forge_dev_7580094c-47e0-495e-80fc-b9c9e8fb8129",\n  "name" : "New biscuit token",\n  "description" : "New biscuit token",\n  "metadata" : { },\n  "keypair_ref" : "biscuit-keypair_dev_d25612c6-b4d0-43ed-a711-16b6c09a5155",\n  "config" : {\n    "checks" : [ ],\n    "facts" : [ ],\n    "resources" : [ ],\n    "rules" : [ ]\n  },\n  "tags" : [ ],\n  "remoteFactsLoaderRef" : null\n}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:["and finally let's create a route that uses the ",(0,s.jsx)(n.code,{children:"client_credentials"})," plugin"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/proxy.otoroshi.io/v1/routes" \\\n  -d \'{\n  "_loc" : {\n    "tenant" : "default",\n    "teams" : [ "default" ]\n  },\n  "id" : "4874704c-56a2-4460-9a21-ff8055a19c75",\n  "name" : "test route",\n  "description" : "test route",\n  "tags" : [ ],\n  "metadata" : { },\n  "enabled" : true,\n  "groups" : [ "default" ],\n  "bound_listeners" : [ ],\n  "frontend" : {\n    "domains" : [ "test.oto.tools/token" ],\n    "strip_path" : true,\n    "exact" : false,\n    "headers" : { },\n    "query" : { },\n    "methods" : [ ]\n  },\n  "backend" : {\n    "targets" : [ {\n      "id" : "www.otoroshi.io",\n      "hostname" : "www.otoroshi.io",\n      "port" : 443,\n      "tls" : true,\n      "weight" : 1,\n      "predicate" : {\n        "type" : "AlwaysMatch"\n      },\n      "protocol" : "HTTP/1.1",\n      "ip_address" : null,\n      "tls_config" : {\n        "certs" : [ ],\n        "trusted_certs" : [ ],\n        "enabled" : false,\n        "loose" : false,\n        "trust_all" : false\n      }\n    } ],\n    "root" : "/",\n    "rewrite" : false,\n    "load_balancing" : {\n      "type" : "RoundRobin"\n    }\n  },\n  "backend_ref" : null,\n  "plugins" : [ {\n    "enabled" : true,\n    "debug" : false,\n    "plugin" : "cp:otoroshi_plugins.com.cloud.apim.otoroshi.extensions.biscuit.plugins.ClientCredentialBiscuitTokenEndpoint",\n    "include" : [ ],\n    "exclude" : [ ],\n    "config" : {\n      "expiration" : 21600000,\n      "forge_ref" : "biscuit-forge_dev_7580094c-47e0-495e-80fc-b9c9e8fb8129"\n    },\n    "bound_listeners" : [ ]\n  } ]\n}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:["now we can call this route to get an ",(0,s.jsx)(n.code,{children:"access_token"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST -H \'Content-Type: application/json\' "http://test.oto.tools:8080/token" -d \'{\n  "grant_type": "client_credentials",\n  "client_id": "apikey_client_id",\n  "client_secret": "apikey_client_secret",\n  "bearer_kind": "biscuit",\n  "aud": "http://test.oto.tools:8080"\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"the result of this call might look something like"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "access_token" : "EosCCqABCgljbGllbnRfaWQKEHdWc0R3bTJYWmxWd0RCQjkKC2NsaWVudF9uYW1lCgR0ZXN0CgNhdWQKG2h0dHA6Ly90ZXN0Lm90by50b29sczo1MDQ1MxgDIgoKCAiACBIDGIEIIgoKCAiCCBIDGIMIIgoKCAiECBIDGIUIMiYKJAoCCBsSBggFEgIIBRoWCgQKAggFCggKBiCi9ei8BgoEGgIIAhIkCAASIO_5F8o1lXRmahr6IPCxyW1X6Mu1Xsk_AsXtNYEySbTLGkDS_usafk7IFXbiXHwJao7_dFt_6CLB6k6dyK56PHP6Pbl-O9Jn3TxbYT4KNVgIW6DAjkHiisM8sB1YSXeTYqAFIiIKINaTmcs4QrNLiGZ45qvOn_ov589DIwNSfLhAeyiWj9bB",\n  "token_type" : "Bearer",\n  "expires_in" : 21600\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"setup-api-route",children:"Setup API route"}),"\n",(0,s.jsx)(n.p,{children:"let's create a biscuit verifier that check if the biscuit token is valid and issued for the right domain with the right apikey"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/biscuit.extensions.cloud-apim.com/v1/biscuit-verifiers" \\\n  -d \'{\n  "enabled" : true,\n  "id" : "biscuit-verifier_dev_1808df91-1878-4be8-9510-c5ea19098852",\n  "keypair_ref" : "biscuit-keypair_dev_d25612c6-b4d0-43ed-a711-16b6c09a5155",\n  "name" : "New biscuit verifier",\n  "description" : "New biscuit verifier",\n  "metadata" : { },\n  "strict" : true,\n  "tags" : [ ],\n  "config" : {\n    "checks" : [ "check if client_id(\\"apikey_client_id\\")", "check if aud(\\"http://test.oto.tools:8080\\")" ],\n    "facts" : [ ],\n    "resources" : [ ],\n    "rules" : [ ],\n    "policies" : [ "allow if true" ],\n    "revokedIds" : [ ]\n  }\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"then let's create the route with the verifier"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl -X POST \\\n  -H \'Content-Type: application/json\' \\\n  -H \'Authorization: Basic xxxx\' \\\n  "http://otoroshi-api.oto.tools:8080/apis/proxy.otoroshi.io/v1/routes" \\\n  -d \'{\n  "_loc" : {\n    "tenant" : "default",\n    "teams" : [ "default" ]\n  },\n  "id" : "bfda6474-0f81-4880-966e-8dae5c2683de",\n  "name" : "test route",\n  "description" : "test route",\n  "tags" : [ ],\n  "metadata" : { },\n  "enabled" : true,\n  "groups" : [ "default" ],\n  "bound_listeners" : [ ],\n  "frontend" : {\n    "domains" : [ "test.oto.tools/api" ],\n    "strip_path" : false,\n    "exact" : false,\n    "headers" : { },\n    "query" : { },\n    "methods" : [ ]\n  },\n  "backend" : {\n    "targets" : [ {\n      "id" : "mirror.otoroshi.io",\n      "hostname" : "mirror.otoroshi.io",\n      "port" : 443,\n      "tls" : true,\n      "weight" : 1,\n      "predicate" : {\n        "type" : "AlwaysMatch"\n      },\n      "protocol" : "HTTP/1.1",\n      "ip_address" : null,\n      "tls_config" : {\n        "certs" : [ ],\n        "trusted_certs" : [ ],\n        "enabled" : false,\n        "loose" : false,\n        "trust_all" : false\n      }\n    } ],\n    "root" : "/",\n    "rewrite" : false,\n    "load_balancing" : {\n      "type" : "RoundRobin"\n    },\n    "health_check" : null\n  },\n  "backend_ref" : null,\n  "plugins" : [ {\n    "enabled" : true,\n    "debug" : false,\n    "plugin" : "cp:otoroshi_plugins.com.cloud.apim.otoroshi.extensions.biscuit.plugins.BiscuitTokenValidator",\n    "include" : [ ],\n    "exclude" : [ ],\n    "config" : {\n      "verifier_ref" : "biscuit-verifier_dev_1808df91-1878-4be8-9510-c5ea19098852"\n    },\n    "bound_listeners" : [ ]\n  }, {\n      "enabled": true,\n      "debug": false,\n      "plugin": "cp:otoroshi.next.plugins.OverrideHost",\n      "include": [],\n      "exclude": [],\n      "config": {},\n      "bound_listeners": [],\n      "plugin_index": {\n        "transform_request": 1\n      }\n  } ]\n}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:["and now let call the route with the biscuit ",(0,s.jsx)(n.code,{children:"access_token"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'curl "http://test.oto.tools:8080/api" \\\n  -H \'Authorization: Bearer EosCCqABCgljbGllbnRfaWQKEHdWc0R3bTJYWmxWd0RCQjkKC2NsaWVudF9uYW1lCgR0ZXN0CgNhdWQKG2h0dHA6Ly90ZXN0Lm90by50b29sczo1MDQ1MxgDIgoKCAiACBIDGIEIIgoKCAiCCBIDGIMIIgoKCAiECBIDGIUIMiYKJAoCCBsSBggFEgIIBRoWCgQKAggFCggKBiCi9ei8BgoEGgIIAhIkCAASIO_5F8o1lXRmahr6IPCxyW1X6Mu1Xsk_AsXtNYEySbTLGkDS_usafk7IFXbiXHwJao7_dFt_6CLB6k6dyK56PHP6Pbl-O9Jn3TxbYT4KNVgIW6DAjkHiisM8sB1YSXeTYqAFIiIKINaTmcs4QrNLiGZ45qvOn_ov589DIwNSfLhAeyiWj9bB\'\n\n{\n  "method" : "GET",\n  "path" : "/api",\n  "headers" : {\n    "host" : "mirror.otoroshi.io",\n    "accept" : "*/*",\n    "user-agent" : "AHC/2.1",\n    "authorization" : "Bearer EosCCqABCgljbGllbnRfaWQKEHdWc0R3bTJYWmxWd0RCQjkKC2NsaWVudF9uYW1lCgR0ZXN0CgNhdWQKG2h0dHA6Ly90ZXN0Lm90by50b29sczo1MDQ1MxgDIgoKCAiACBIDGIEIIgoKCAiCCBIDGIMIIgoKCAiECBIDGIUIMiYKJAoCCBsSBggFEgIIBRoWCgQKAggFCggKBiCi9ei8BgoEGgIIAhIkCAASIO_5F8o1lXRmahr6IPCxyW1X6Mu1Xsk_AsXtNYEySbTLGkDS_usafk7IFXbiXHwJao7_dFt_6CLB6k6dyK56PHP6Pbl-O9Jn3TxbYT4KNVgIW6DAjkHiisM8sB1YSXeTYqAFIiIKINaTmcs4QrNLiGZ45qvOn_ov589DIwNSfLhAeyiWj9bB",\n    "x-forwarded-for" : "45.80.20.1",\n    "forwarded" : "proto=https;for=45.80.20.1:51029;by=91.208.207.223",\n    "x-forwarded-port" : "443",\n    "x-forwarded-proto" : "https",\n    "sozu-id" : "01JJRK7TERSK9776XHKM7590BS"\n  },\n  "body" : null\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},89229:(e,n,t)=>{t(96540),t(74848)},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(96540);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);