---
sidebar_position: 4
---

import Terminal from '@site/src/components/Terminal';

# Forges

## Prerequisites

- A [Biscuit KeyPair](/docs/entities/keypairs)

- A datalog:
  - An array of biscuit Facts (could be empty)
  - An array of biscuit Checks (could be empty)
  - An array of biscuit Resources (could be empty)
  - An array of biscuit Rules (could be empty)

### Example Configuration

```json
{
  "checks": [
    "check if resource(\"file1\")" 
  ],
  "facts": [
    "user(\"random_user\")",
    "plan(\"basic\")",
    "role(\"editor\")",
    "resource(\"file1\")"
  ],
  "resources": [
    "file1",
    "file2"
  ],
  "rules": [
    "allow if user(\"random_admin\");",
    "allow if role(\"editor\") and resource(\"file1\");"
  ],
  "enableTtl": true,
  "ttl": 7200000
}
```

### Explanation

#### Facts
Facts define statements that are always true within the token's logic:
```datalog
user("random_user");
plan("basic");
role("editor");
resource("file1");
```
This configuration declares a `user("random_user")`, assigns the `plan("basic")`, sets a `role("editor")`, and defines access to `resource("file1")`.

#### Checks
Checks are conditions that must be satisfied for authorization:
```datalog
check if resource("file1");
```
This check ensures that the resource being accessed is "file1".

#### Resources
Resources define entities that the biscuit token controls access to:
```datalog
file1;
file2;
```
This configuration lists "file1" and "file2" as resources.

#### Rules
Rules define logical inferences based on facts and other rules:
```datalog
allow if user("random_admin");
allow if role("editor") and resource("file1");
```
These rules allow access if the user is "random_admin" or if they have the "editor" role and are accessing "file1".

#### Time-to-Live (TTL)
- `enableTtl: true` indicates that a TTL (Time-to-Live) mechanism is active.
- `ttl: 7200000` sets the TTL to 7,200,000 milliseconds (2 hours), meaning the token expires in 2 hours.

### Example Usage
If you want to authorize an editor role for file access, you could extend the configuration as follows:
```datalog
allow if role("editor") and resource("file1");
```
This would allow access for an "editor" to "file1".

# Example : a Generated token with the Biscuit Forge

```javascript
{
  "id": "biscuit_token_0531505a-ae44-4022-983d-9b035786f55a",
  "name": "Biscuit Token Name",
  "description": "A simple Biscuit Token",
  "keypair_ref": "biscuit_keypair_e42033bc-f181-485f-857d-576e4728f6f9",
  "config": {
    "checks": [
      "check if time($date), $date <= 2024-12-30T19:00:10Z;"
    ],
    "facts": [
      "user(\"demo\")",
      "role(\"dev\")",
      "time(2024-12-18T20:00:00Z)"
    ],
    "resources": [],
    "rules": []
  },
  "token": "GENERATED_TOKEN_HERE",
  "tags": [],
  "kind": "biscuit.extensions.cloud-apim.com/BiscuitTokenForge"
}
```


## Generate a Biscuit Token from command line (using the Forge entity)
```bash 
curl -X POST -H 'Content-Type: application/json' 'http://otoroshi-api.oto.tools:8080/apis/biscuit.extensions.cloud-apim.com/v1/tokens-forge' -u admin-api-apikey-id:admin-api-apikey-secret -d '{
  "id": "biscuit_token_0531505a-ae44-4022-983d-9b035786f55a",
  "name": "Biscuit Token Name",
  "description": "A simple Biscuit Token",
  "keypair_ref": "biscuit_keypair_e42033bc-f181-485f-857d-576e4728f6f9",
  "config": {
    "checks": [
      "check if time($date), $date <= 2024-12-30T19:00:10Z;"
    ],
    "facts": [
      "user(\"demo\")",
      "role(\"dev\")",
      "time(2024-12-18T20:00:00Z)"
    ],
    "resources": [],
    "rules": []
  },
  "token": "GENERATED_TOKEN_HERE",
  "tags": [],
  "kind": "biscuit.extensions.cloud-apim.com/BiscuitTokenForge"
}'
```